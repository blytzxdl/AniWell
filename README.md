# FileServer-for-qBittorrent v0.5.0

## 说明

​		此后本项目为Typescript+Vite+Vue3+Nodejs+Express+Electron+Prettier编写的全栈项目，定位为资源管理服务器，能综合管理用户所存储的各类资源，如视频、音乐等，并能通过客户端直接播放/阅览/...，但当前开发首先以流媒体服务器为标准，完成具有拓展性、复用性的基础架构。旧功能等待逐步迁移，新功能预计将通过插件形式实现。

开发说明

- 后端部分
  - 基础共用模块：
    - 存储系统：主要使用env-paths + electron-store，在**规范的位置**存储json数据，部分数据通过**Proxy**简化读写及存储
    - 日志系统：使用log4js在本地存储日志文件，动态切换日志等级。（待完成：通过Websocket同步到客户端）
  - 路由及API模块：使用express router配置**多级路由**，实现**RESTful API**，部分数据通过**gzip进行压缩**
    - 约定：成功且无响应数据时，仅设置res.code(200).end()，错误且需要提醒时，返回{message:'提醒消息',alert:true}（待完成）
  - 安全模块：
    - ssl加密：用户未配置ssl证书时，使用selfsigned生成**自签名证书**，同时用于**https及jwt签名**，保障信息安全
    - 用户：登录注册时接收到的密码实为用户密码的hash值，本地保存的用户密码为通过bcryptjs再次进行加密的hash值，**避免明文传输或存储**原始密码
    - 鉴权：
      - 在用户登录验证成功时，通过jsonwebtoken生成**RSA签名**的token，
      - 在响应头中设置**httpOnly**和**secure**的**cookie**来存储token，**防范xss攻击**，并免去前端发送请求时主动设置cookie，更加方便
      - 接收请求时，在路由**顶层进行鉴权**，获取请求中的token并通过jsonwebtoken校验
      - 维护一个废弃token存储库，在jwt校验环节加入**废弃token校验**，防止jwt的无状态特性引发安全问题
  - 视频服务模块：贯彻**面向对象**思想，主要使用nodejs的**child_process**调用ffmpeg进行视频处理
    - 顶层为任务队列控制器，请求视频链接时，根据请求参数及视频文件信息生成合适类型的任务，并返回带有uuid的链接等信息；请求视频内容时根据链接中的uuid找到对应的任务，将请求交给任务中的控制器处理
    - 字幕信息和任务关联，根据uuid信息获取其本地路径，不满足条件的字幕将经过ffmpeg处理，最后并返回（gzip压缩待完成）
    - 字体由于无隐私，与视频关联弱，会统一复制或用7z解压到特定路径，由express.static提供服务（gzip压缩待完成）
    - 直接串流类型：根据请求头中的range信息创建视频片段的可读流，通过pipe压入响应体，并在响应头中设置相关range信息
    - 转码串流类型：旧版已完成，待迁移
  - 媒体库模块：旧版已完成，待迁移



- 前端部分
  - 技术栈：Vue Router + Pinia + Element Plus + Vant + Less + Axios + VueUse + bcrypt + 响应式布局 + 自动导入 + ...
  - API模块：
    - 使用Axios封装请求，通过响应拦截器将约定格式的返回结果进行简化，方便使用
    - 通过请求拦截器拦截部分请求，返回缓存好的数据（待完成）
    - 约定：code200且无数据时，返回true，有数据时，返回数据。错误且无alert时，返回false，alert为true时，通过toast提醒（待完成）
  - 存储模块：
    - 主要使用**Pinia**管理，部分用户数据如自定义样式等，通过$subscribe api实现**持久化存储**
    - 部分不方便用pinia管理的非响应式数据，使用**Proxy+LocalStorage**来管理
    - 使用indexDB实现大型数据的缓存（待完成）
  - 路由模块：
    - 对于登录及初始化等涉及**安全**问题的页面，使用beforeEnter严格控制进入条件
    - 对于其它页面，通过在beforeEach中校验登录状态来控制
  - 登录模块：根据不同的用户输入及状态来处理登录，
    - 常规流程为：根据用户名请求对应的**salt** -> 通过**bcryptjs**+salt为密码生成**hash** -> 将用户名及密码的hash值发送给后端校验 -> 获取到**httponly**的**jwt token**，完成登录
    - 为了安全和方便，salt值放进本地存储，**减少请求**salt的次数，并且尝试检查是否已有token，已有token时则尝试仅通过token请求登录，以实现**自动登录**并且**减少**用户名及密码hash的**发送**次数
  - 主题样式：基于Element Plus主题，通过VueUse/useCssVar进行覆盖修改，支持**动态修改**及**用户自定义**
  - 媒体库页面及卡片组件：
    - 布局：媒体库页面接收树形数据，使用宫格布局展示卡片组件，卡片组件使用**懒加载**，根据媒体库页面宽度、卡片列数及卡片纵横比**动态调整**字体大小和布局
    - 导航：通过分页器或具有特定标签的卡片进行路由跳转，通过跳转时附带的**路由信息**请求新数据，实现页面更新或打开特定功能页面
  - 视频播放器组件：使用dplayer+hls.js+libass-wasm(subtitles-octopus)，根据服务端返回的视频数据自动生成合适的配置项，对libass-wasm的**WebWorker**部分做修改以完成适配及实现特定功能（数据压缩、缓存等，未全部完成）
